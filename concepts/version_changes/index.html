
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../schema_generation/">
      
      
        <link rel="next" href="../endpoint_migrations/">
      
      
      <link rel="icon" href="../../img/logos/cadwyn_icon_transparent.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Version Changes - Cadwyn</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#version-changes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Cadwyn" class="md-header__button md-logo" aria-label="Cadwyn" data-md-component="logo">
      
  <img src="../../img/logos/cadwyn_icon_transparent.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cadwyn
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Version Changes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/zmievsa/cadwyn" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Cadwyn
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../quickstart/setup/" class="md-tabs__link">
          
  
  
    
  
  Quickstart

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../how_to/" class="md-tabs__link">
          
  
  
    
  
  How to...

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../home/CONTRIBUTING/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../home/CHANGELOG/" class="md-tabs__link">
        
  
  
    
  
  Changelog

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../theory/how_we_got_here/" class="md-tabs__link">
          
  
  
    
  
  Theory

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Cadwyn" class="md-nav__button md-logo" aria-label="Cadwyn" data-md-component="logo">
      
  <img src="../../img/logos/cadwyn_icon_transparent.svg" alt="logo">

    </a>
    Cadwyn
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zmievsa/cadwyn" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Cadwyn
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Quickstart
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../how_to/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    How to...
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            How to...
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/version_with_paths_and_numbers_instead_of_headers_and_dates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Version with paths and numbers instead of headers and dates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Change OpenAPI Schemas
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Change OpenAPI Schemas
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/change_openapi_schemas/add_field/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add a field
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/change_openapi_schemas/remove_field/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Remove a field
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/change_openapi_schemas/rename_a_field_in_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rename a field
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/change_openapi_schemas/change_field_type/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Change field type
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/change_openapi_schemas/changing_constraints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Change field constraints or validators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/change_openapi_schemas/change_schema_without_endpoint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Change a schema that is not used in any endpoint
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/change_business_logic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Change business logic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/change_endpoints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Change endpoints
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../methodology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Methodology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../beware_of_data_versioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beware of data versioning
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../main_app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Main App
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schema_generation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Schema generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Version Changes
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Version Changes
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#versionbundle" class="md-nav__link">
    <span class="md-ellipsis">
      VersionBundle
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version" class="md-nav__link">
    <span class="md-ellipsis">
      Version
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Version">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#headversion" class="md-nav__link">
    <span class="md-ellipsis">
      HeadVersion
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#versionchange" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VersionChange">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionchange__name__" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.__name__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionchangedescription" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.description
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionchangeinstructions_to_migrate_to_previous_version" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.instructions_to_migrate_to_previous_version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      Data migrations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#path-based-migration-specification" class="md-nav__link">
    <span class="md-ellipsis">
      Path-based migration specification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-of-http-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Migration of HTTP errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-of-non-body-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Migration of non-body attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-representations" class="md-nav__link">
    <span class="md-ellipsis">
      Internal representations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-body-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      Manual body migrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamingresponse-and-fileresponse-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      StreamingResponse and FileResponse migrations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic-rootmodel-migration-warning" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic RootModel migration warning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependency-re-execution-warning" class="md-nav__link">
    <span class="md-ellipsis">
      Dependency re-execution warning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-changes-with-side-effects" class="md-nav__link">
    <span class="md-ellipsis">
      Version changes with side effects
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Version changes with side effects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#warning-against-side-effects" class="md-nav__link">
    <span class="md-ellipsis">
      Warning against side effects
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../endpoint_migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Endpoint migrations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../enum_migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Enum migrations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schema_migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Schema migrations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api_version_parameter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Version parameter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelogs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelogs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../home/CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../home/CHANGELOG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Theory
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Theory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/how_we_got_here/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How we got here
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/literature/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Literature
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/how_to_build_versioning_framework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How to build a versioning framework
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#versionbundle" class="md-nav__link">
    <span class="md-ellipsis">
      VersionBundle
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version" class="md-nav__link">
    <span class="md-ellipsis">
      Version
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Version">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#headversion" class="md-nav__link">
    <span class="md-ellipsis">
      HeadVersion
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#versionchange" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VersionChange">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionchange__name__" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.__name__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionchangedescription" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.description
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versionchangeinstructions_to_migrate_to_previous_version" class="md-nav__link">
    <span class="md-ellipsis">
      VersionChange.instructions_to_migrate_to_previous_version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      Data migrations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#path-based-migration-specification" class="md-nav__link">
    <span class="md-ellipsis">
      Path-based migration specification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-of-http-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Migration of HTTP errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-of-non-body-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Migration of non-body attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-representations" class="md-nav__link">
    <span class="md-ellipsis">
      Internal representations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-body-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      Manual body migrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamingresponse-and-fileresponse-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      StreamingResponse and FileResponse migrations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic-rootmodel-migration-warning" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic RootModel migration warning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependency-re-execution-warning" class="md-nav__link">
    <span class="md-ellipsis">
      Dependency re-execution warning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-changes-with-side-effects" class="md-nav__link">
    <span class="md-ellipsis">
      Version changes with side effects
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Version changes with side effects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#warning-against-side-effects" class="md-nav__link">
    <span class="md-ellipsis">
      Warning against side effects
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="version-changes">Version Changes<a class="headerlink" href="#version-changes" title="Permanent link">&para;</a></h1>
<p>Version changes are the backbone of Cadwyn. They allow to describe things like "This field in that schema had a different name in an older version" or "this endpoint did not exist in all earlier versions".</p>
<p>In Cadwyn, your business logic always works with a single version -- HEAD, which is the representation of your latest version. This approach decouples your business logic from versioning and allows you to have hundreds of API versions using the same database models and business logic while staying sane.</p>
<p>Follow these steps to add a new version:</p>
<ol>
<li>Make a breaking change in your HEAD version</li>
<li>Reverse it for all your older versions using special "migration instructions" so that your current users are not affected by the breaking changes</li>
</ol>
<p>These migration instructions for reverting the breaking changes are gathered into groups to make them easier to maintain. Let's say you want to rename the <code>creation_date</code> field to <code>created_at</code> but you also want to delete the <code>GET /v1/tax_ids</code> endpoint: these changes are unrelated so they should be placed into different groups.</p>
<p>On the other hand, deletion of the <code>POST /v1/tax_ids</code> endpoint should go into the same group as the deletion of <code>GET /v1/tax_ids</code>. These groups are very important to make the changes easily understandable for both your users and your developers.</p>
<p>Each such group is called a <strong>version change</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># versions/v2023_02_10.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">endpoint</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoveTaxIdEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Remove `GET /v1/tax_ids` and `POST /v1/tax_ids` endpoints&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;/v1/tax_ids&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">existed</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<p>After you have described them, you add your version change class(es) into your version bundle to activate them:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># versions/__init__.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeadVersion</span><span class="p">,</span> <span class="n">Version</span><span class="p">,</span> <span class="n">VersionBundle</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.v2023_02_10</span><span class="w"> </span><span class="kn">import</span> <span class="n">RemoveTaxIdEndpoints</span>

<span class="n">versions</span> <span class="o">=</span> <span class="n">VersionBundle</span><span class="p">(</span>
    <span class="n">HeadVersion</span><span class="p">(),</span>
    <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2023-02-10&quot;</span><span class="p">,</span> <span class="n">RemoveTaxIdEndpoints</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2022-11-16&quot;</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<p>This instructs Cadwyn to <strong>un</strong>delete these endpoints in all versions older than 2023-02-10.</p>
<p>Now let's discuss what each of these parts does and why:</p>
<h2 id="versionbundle">VersionBundle<a class="headerlink" href="#versionbundle" title="Permanent link">&para;</a></h2>
<p><code>VersionBundle</code> is your single source of truth for your list of versions. It contains your list of versions and all <a href="#version-changes">version changes</a> associated with them. Each version change is a single group of breaking changes. Each <code>Version</code> contains a group of version changes that caused this version to be created. For example, if I delete the <code>POST /v1/tax_ids</code> endpoint in version <code>2023-02-10</code>, then I'll add a version change for deleting that endpoint into <code>2023-02-10</code>. For example:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># versions/__init__.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeadVersion</span><span class="p">,</span> <span class="n">Version</span><span class="p">,</span> <span class="n">VersionBundle</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.v2023_02_10</span><span class="w"> </span><span class="kn">import</span> <span class="n">RemoveTaxIdEndpoints</span>

<span class="n">versions</span> <span class="o">=</span> <span class="n">VersionBundle</span><span class="p">(</span>
    <span class="n">HeadVersion</span><span class="p">(),</span>
    <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2023-02-10&quot;</span><span class="p">,</span> <span class="n">RemoveTaxIdEndpoints</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2022-11-16&quot;</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<p>Did you notice that the first version <code>2022-11-16</code> does not have any version changes? That is intentional! How can it have breaking changes if there are no prior versions before it?</p>
<h2 id="version">Version<a class="headerlink" href="#version" title="Permanent link">&para;</a></h2>
<p><code>Version</code> is simply an ordered collection of version changes that allows to describe when each version change happened so that Cadwyn is able to generate your schemas and routes for all versions correctly, based on which version changes are located in which versions.</p>
<h3 id="headversion">HeadVersion<a class="headerlink" href="#headversion" title="Permanent link">&para;</a></h3>
<p>Cadwyn has a special HEAD version: it is the only version you will create manually and use directly in your business logic. It is also the version that is used by Cadwyn for generating all other versions.</p>
<p>When handling an HTTP request, Cadwyn first validates it with the appropriate API version, then Cadwyn applies all converters from the request's API version and up to the latest API version to it, and then finally Cadwyn converts the request to the appropriate schema from HEAD version (the schema that was used for generating the versioned schema from request's API version).</p>
<p>So Cadwyn migrates all requests from all versions to HEAD version to make sure that your business logic operates with only one version.</p>
<p>HEAD is very similar to your latest version but for a few key differences:</p>
<ul>
<li>Latest is user-facing while HEAD is only used internally by you and Cadwyn</li>
<li>Latest is generated while HEAD is maintained by you manually</li>
<li>Latest only includes the fields that our user is supposed to see in the latest version while HEAD can include some fields missing from latest. For example, if an earlier version contained a field completely incompatible with latest, HEAD will have it too to make sure that old versions can function the same as before. This also applies to field types: if a field is required in latest but was nullable in an earlier version, then HEAD will have it as nullable to make sure that any earlier version request can easily be converted into a HEAD request</li>
<li>Latest can include constraints that are incompatible with older versions while HEAD can contain no constraints at all if you want -- the user-facing schemas are applied for validation before the request is converted to HEAD so HEAD does not need to re-validate anything if you do not want it to</li>
</ul>
<h2 id="versionchange">VersionChange<a class="headerlink" href="#versionchange" title="Permanent link">&para;</a></h2>
<p><code>VersionChange</code> classes describe each atomic group of business capabilities that you have altered in a version.</p>
<p>Note, however, that you only need to have a migration if it is a breaking change for your users. If you add a new endpoint or add a new field to your response schema, you do not need to have a migration for it because your users' code will not break. So by not having a migration you automatically add this change to all versions.</p>
<h3 id="versionchange__name__">VersionChange.__name__<a class="headerlink" href="#versionchange__name__" title="Permanent link">&para;</a></h3>
<p>The name of a version change, for example <code>RemoveTaxIdEndpoints</code>, describes what breaking change has happened. It must be a verb and it is the best clue for your new developers to quickly understand what happened between the versions. Feel free to use long names: it is better to have a long name than a name that fails to convey what exactly happened. Better have a voluminous name such as <code>RenameCreationDatetimeAndUpdateDatetimeToCreatedAtAndUpdatedAt</code> than to have a generic name such as <code>RefactorFields</code>. Because after just a few of such version changes your versioning structure can become completely unreadable:</p>
<div class="highlight"><pre><span></span><code><span class="n">versions</span> <span class="o">=</span> <span class="n">VersionBundle</span><span class="p">(</span>
    <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2023-05-09&quot;</span><span class="p">,</span> <span class="n">ChangeCreateLogic</span><span class="p">,</span> <span class="n">AddRequiredFields</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2023-04-02&quot;</span><span class="p">,</span> <span class="n">DeleteEndpoint</span><span class="p">,</span> <span class="n">ChangeFields</span><span class="p">,</span> <span class="n">RenameFields</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2023-02-10&quot;</span><span class="p">,</span> <span class="n">RenameEndpoints</span><span class="p">,</span> <span class="n">RefactorFields</span><span class="p">),</span>
    <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;2022-11-16&quot;</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<h3 id="versionchangedescription">VersionChange.description<a class="headerlink" href="#versionchangedescription" title="Permanent link">&para;</a></h3>
<p>The description field of your version change must be even more detailed. In fact, it is intended to be the <strong>name</strong> and the <strong>summary</strong> of the version change for your clients. It must clearly state to you clients <strong>what happened</strong> and <strong>why</strong>. So you need to make it grammatically correct, detailed, specific, and written for humans. Note that you do not have to use a strict machine-readable format -- it is a portion of documentation, not a set of instructions. Let's take <a href="https://stripe.com/blog/api-versioning">Stripe's description</a> to one of their version changes as an example:</p>
<div class="highlight"><pre><span></span><code>Event objects (and webhooks) will now render a <span class="sb">`request`</span> subobject that contains a request Id and idempotency key instead of just a string request Id.
</code></pre></div>
<p>It is concise, descriptive, and human-readable -- just like any good documentation. Now let's have a look at a bad description:</p>
<div class="highlight"><pre><span></span><code>Migration from first version (2022-11-16) to 2023-09-01 version.
Changes:
<span class="k">*</span><span class="w"> </span>Changed schema for &#39;POST /v1/tax_ids&#39; endpoint
</code></pre></div>
<ul>
<li>Its first line, <code>Migration from first version (2022-11-16) to 2023-09-01 version.</code>, duplicates the already-known information -- your developers will know which version <code>VersionChange</code> migrates to and from by its location in <a href="#versionbundle">VersionBundle</a> and most likely by its file name. So it is redundant information</li>
<li>Its second line, <code>Changes:</code>, does not provide useful information either because description of a <code>VersionChange</code> cannot describe anything but changes. So again, it is redundant information</li>
<li>Its third line, <code>Changed schema for 'POST /v1/tax_ids' endpoint</code>, gives both too much and too little information. It states changing of a schema but it does not mention what exactly was changed. The goal is to make it easy for our clients to migrate from one version to another. The recommended description here is to mention the OpenAPI model name that you changed, the fields you changed, and why you changed them</li>
</ul>
<h3 id="versionchangeinstructions_to_migrate_to_previous_version">VersionChange.instructions_to_migrate_to_previous_version<a class="headerlink" href="#versionchangeinstructions_to_migrate_to_previous_version" title="Permanent link">&para;</a></h3>
<p>In Cadwyn, you use the latest version. This attribute is a way for you to describe how your schemas and endpoints looked in previous versions so that Cadwyn can guess schema and route generation to recreate the old schemas and endpoints for your clients. So you only need to maintain your head (latest) schemas and your migrations while Cadwyn takes care of the rest. In fact, you spend minimal effort on <strong>maintaining</strong> your migrations because they are effectively immutable -- they describe the breaking changes that happened in the past so there is no need to ever change them.</p>
<p>This approach of <em>maintaining the present and describing the past</em> might appear weird. You just need to form the correct mindset which is counter-intuitive at first but after just one or two attempts at versioning you will see how much sense this approach makes.</p>
<p>Imagine you needed to know what your code looked like two weeks ago. You would use <code>git checkout</code> or <code>git reset</code> with an older commit because <code>git</code> stores the latest version of your code (which is also called HEAD) and the diffs between it and each previous version as a chain of changes. This is exactly how Cadwyn works! We store the latest version and use the diffs to regenerate the older versions.</p>
<details>
  <summary>Note to curious readers</summary>

  Git doesn't actually work this way internally. My description is closer to how SVN works. It is just a really simplistic metaphor to explain a concept.
</details>

<h3 id="data-migrations">Data migrations<a class="headerlink" href="#data-migrations" title="Permanent link">&para;</a></h3>
<p>Let's say we renamed the field <code>creation_date</code> to <code>created_at</code>. We have altered our schemas -- that's great! But when our clients send us requests using the old versions of our API -- we will still get the data where we have <code>creation_date</code> instead of <code>created_at</code>. How do we solve this? Well, in Cadwyn your business logic never receives requests of the old versions. Instead, it receives only the requests of the latest version. So when you define a version change that renames a field, you need to also define how to convert the request body from the old version to the newer version. For example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RequestInfo</span><span class="p">,</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">convert_request_to_next_version_for</span><span class="p">,</span>
    <span class="n">schema</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">invoices</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvoiceCreateRequest</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoveTaxIdEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Rename `Invoice.creation_date` to `Invoice.created_at`.&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">InvoiceCreateRequest</span><span class="p">)</span>
        <span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@convert_request_to_next_version_for</span><span class="p">(</span><span class="n">InvoiceCreateRequest</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_creation_date_to_created_at</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RequestInfo</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Did you notice how the schema for <code>InvoiceCreateRequest</code> is specified in our migration? This will signal to Cadwyn to apply it to all routes that have this schema as their body.</p>
<p>Now we have not only described how schemas changed but we have also described how to migrate a request of the old version to the new version. When Cadwyn receives a request targeting a particular version, the request is first validated against the schema of that particular version. Then Cadwyn applies all request migrations until the latest version to migrate the request to latest. So now your business logic receives the latest version of the request yet for your clients you have two versions of your API -- you have added variability without introducing any complexity into your business logic.</p>
<p>But wait... What happens to the <code>Invoice</code> responses? Your business logic will now return <code>created_at</code> so your clients from old versions will be affected! Cadwyn has a tool for that too: we migrate our responses as well. Requests were migrated forward in versions but responses are migrated backward in versions! So your business logic returns a response of the latest version and Cadwyn will use your response migrations to migrate it back to the version of your client's request:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RequestInfo</span><span class="p">,</span>
    <span class="n">ResponseInfo</span><span class="p">,</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">convert_request_to_next_version_for</span><span class="p">,</span>
    <span class="n">convert_response_to_previous_version_for</span><span class="p">,</span>
    <span class="n">schema</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">invoices</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseInvoice</span><span class="p">,</span>
    <span class="n">InvoiceCreateRequest</span><span class="p">,</span>
    <span class="n">InvoiceResource</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoveTaxIdEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Rename `Invoice.creation_date` to `Invoice.created_at`.&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">BaseInvoice</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@convert_request_to_next_version_for</span><span class="p">(</span><span class="n">InvoiceCreateRequest</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_creation_date_to_created_at</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RequestInfo</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span>

    <span class="nd">@convert_response_to_previous_version_for</span><span class="p">(</span><span class="n">InvoiceResource</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_created_at_to_creation_date</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">ResponseInfo</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Did you notice how the schema for <code>InvoiceResource</code> is specified in our migration? This will signal to Cadwyn to apply it to all routes that have this schema as their <code>response_model</code>. Notice also that we now use <code>BaseInvoice</code> in our instructions -- let's imagine that it is the parent of both <code>InvoiceCreateRequest</code> and <code>InvoiceResource</code> so renaming it there will rename it in these schemas as well. You can, however, apply the instructions to both individual schemas instead of their parent if you want to.</p>
<p>Now our request comes, Cadwyn migrates it to the latest version using our request migration, then we do our business logic, return the latest response from it, and Cadwyn migrates it back to the request version. Does our business logic or database know about the fact that we have two versions? No, not at all! It is zero-cost. Imagine how beneficial it is when you support not two but two hundred versions.</p>
<p><img alt="The diagram showing how it works" src="../../img/simplified_migration_model.png" /></p>
<p><strong>Notice</strong> how we used the <strong>latest</strong> versions of our schemas in our migration -- this pattern can be found everywhere in Cadwyn. The latest version of your schemas is used to describe what happened to all other versions because other versions might not exist when you are defining migrations for them.</p>
<h4 id="path-based-migration-specification">Path-based migration specification<a class="headerlink" href="#path-based-migration-specification" title="Permanent link">&para;</a></h4>
<p>Oftentimes you need to migrate based on the endpoint path rather than the request body or response model. This happens when, for example, endpoint does not have a request body or its response model is used in other places that we do not want to migrate. Consider the example <a href="#data-migrations">above</a>, but use paths instead of schemas:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RequestInfo</span><span class="p">,</span>
    <span class="n">ResponseInfo</span><span class="p">,</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">convert_request_to_next_version_for</span><span class="p">,</span>
    <span class="n">convert_response_to_previous_version_for</span><span class="p">,</span>
    <span class="n">schema</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">invoices</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseInvoice</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoveTaxIdEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Rename `Invoice.creation_date` to `Invoice.created_at`.&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">BaseInvoice</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">had</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@convert_request_to_next_version_for</span><span class="p">(</span><span class="s2">&quot;/v1/invoices&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_creation_date_to_created_at</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RequestInfo</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;creation_date&quot;</span><span class="p">)</span>

    <span class="nd">@convert_response_to_previous_version_for</span><span class="p">(</span><span class="s2">&quot;/v1/invoices&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_created_at_to_creation_date</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">ResponseInfo</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Though I highly recommend you to stick to schemas as it is much easier to introduce inconsistencies when using paths; for example, when you have 10 endpoints with the same response body schema but you forgot to add migrations for 3 of them because you use paths instead of schemas.</p>
<h4 id="migration-of-http-errors">Migration of HTTP errors<a class="headerlink" href="#migration-of-http-errors" title="Permanent link">&para;</a></h4>
<p>Oftentimes you need to raise <code>fastapi.HTTPException</code> in your code to signal some errors to your users. However, if you want to change the status code of some error, it would be a breaking change because your error status codes and sometimes even their bodies are a part of your API contract.</p>
<p>By default, Cadwyn's response migrations do not handle errors but you can use the <code>migrate_http_errors</code> keyword argument to enable it:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ResponseInfo</span><span class="p">,</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">convert_response_to_previous_version_for</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoveTaxIdEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Change status code in &#39;GET /v1/invoices&#39; when invoice was not found from 400 to 404&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">()</span>

    <span class="nd">@convert_response_to_previous_version_for</span><span class="p">(</span>
        <span class="s2">&quot;/v1/invoices&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="n">migrate_http_errors</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_400_to_404</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">ResponseInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
</code></pre></div>
<h4 id="migration-of-non-body-attributes">Migration of non-body attributes<a class="headerlink" href="#migration-of-non-body-attributes" title="Permanent link">&para;</a></h4>
<p>Cadwyn can migrate more than just request bodies.</p>
<p><code>RequestInfo</code> has the following interfaces to migrate requests:</p>
<ul>
<li><code>body: Any</code></li>
<li><code>headers: starlette.datastructures.MutableHeaders</code></li>
<li><code>cookies: dict[str, str]</code></li>
<li><code>query_params: dict[str, str]</code></li>
</ul>
<p><code>ResponseInfo</code> has the the following interfaces to migrate responses:</p>
<ul>
<li><code>body: Any</code></li>
<li><code>status_code: int</code></li>
<li><code>headers: starlette.datastructures.MutableHeaders</code></li>
<li><a href="https://www.starlette.io/responses/#set-cookie">set_cookie</a></li>
<li><a href="https://www.starlette.io/responses/#delete-cookie">delete_cookie</a></li>
</ul>
<h4 id="internal-representations">Internal representations<a class="headerlink" href="#internal-representations" title="Permanent link">&para;</a></h4>
<p>We have only reviewed simplistic cases so far. But what happens when you cannot just migrate your data that easily? It can happen because your earlier versions had <strong>more data</strong> than your newer versions. Or that data had more formats.</p>
<p>Let's imagine that previously the <code>User</code> schema had a list of addresses but now we want to make a breaking change and turn them into a single address. The naive migration will just take the first address from the list for requests and turn that one address into a list for responses like so:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RequestInfo</span><span class="p">,</span>
    <span class="n">ResponseInfo</span><span class="p">,</span>
    <span class="n">VersionChange</span><span class="p">,</span>
    <span class="n">convert_request_to_next_version_for</span><span class="p">,</span>
    <span class="n">convert_response_to_previous_version_for</span><span class="p">,</span>
    <span class="n">schema</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">users</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUser</span>


<span class="c1"># THIS IS AN EXAMPLE OF A BAD MIGRATION</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RemoveTaxIdEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Users now have `address` field instead of `addresses`&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">BaseUser</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">didnt_exist</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">BaseUser</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">existed_as</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="nd">@convert_request_to_next_version_for</span><span class="p">(</span><span class="n">BaseUser</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">turn_addresses_into_a_single_item</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">RequestInfo</span><span class="p">):</span>
        <span class="n">addresses</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span>
        <span class="c1"># The list could have been empty in the past so new &quot;address&quot;</span>
        <span class="c1"># field must be nullable.</span>
        <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">addresses</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@convert_response_to_previous_version_for</span><span class="p">(</span><span class="n">BaseUser</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">turn_address_into_a_list</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">ResponseInfo</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;addresses&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)]</span>
</code></pre></div>
<p>But this will not work. Now when the user from the old version asks us to save three addresses, we will in fact save only one. Old data is also going to be affected -- if old users had multiple addresses, we will only be able to return one of them. This is bad -- we have made a breaking change!</p>
<p>In order to solve this issue, Cadwyn uses a concept of <strong>internal representations</strong>. An internal representation of your data is like a database entry of your data -- it is its <strong>latest</strong> version plus all the fields that are incompatible with the latest API version. If we were talking about classes, then internal representation would be a child of your latest schemas -- it has all the same data and a little more, it expands its functionality. Essentially your internal representation of user object can contain much more data than your latest schemas.</p>
<p>So all your requests get migrated to HEAD, which is the internal representation of latest -- but not exactly the latest itself. So its data is really similar to latest. Same happens to your responses -- you do not respond with and migrate from the latest version of your data, you respond with its <strong>internal representation</strong> which is really close to the actual latest schemas.</p>
<p>In responses, returning the internal representation is simple: just return your database model or a dict with everything you need for all your versions. In the user address example, we would continue storing the list of addresses in our database but then add the single address to our response. Latest schemas will simply strip it but our older schemas will be able to use it!</p>
<div class="highlight"><pre><span></span><code><span class="c1"># in your business logic</span>

<span class="k">return</span> <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">addresses</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">user</span><span class="p">}</span>
</code></pre></div>
<p>So now your migration will look like the following:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="n">VersionChange</span><span class="p">,</span> <span class="n">schema</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">users</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoveTaxIdEndpoints</span><span class="p">(</span><span class="n">VersionChange</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Users now have `address` field instead of `addresses`&quot;</span>
    <span class="n">instructions_to_migrate_to_previous_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">didnt_exist</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">existed_as</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]),</span>
    <span class="p">)</span>
</code></pre></div>
<p>Yes, we do not need any of the migrations anymore because responses are handled automatically. See how-to section for an example of how we would achieve the same feat for requests.</p>
<h4 id="manual-body-migrations">Manual body migrations<a class="headerlink" href="#manual-body-migrations" title="Permanent link">&para;</a></h4>
<p>Oftentimes you will have a need to migrate your data outside of routing, manually. For example, when you need to send a versioned response to your client via webhook or inside a worker/cronjob. In these instances, you can use <code>cadwyn.VersionBundle.migrate_response_body</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">users</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserResource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">versions</span><span class="w"> </span><span class="kn">import</span> <span class="n">version_bundle</span>

<span class="n">body_from_2000_01_01</span> <span class="o">=</span> <span class="n">version_bundle</span><span class="o">.</span><span class="n">migrate_response_body</span><span class="p">(</span>
    <span class="n">UserResource</span><span class="p">,</span> <span class="n">latest_body</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">},</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;2000-01-01&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p>The returned <code>body_from_2000_01_01</code> is your data passed through all converters (similar to how it would when a response is returned from your route) and wrapped into <code>data.v2000_01_01.UserResource</code>. Because it is wrapped, we can include Pydantic’s defaults.</p>
<h4 id="streamingresponse-and-fileresponse-migrations">StreamingResponse and FileResponse migrations<a class="headerlink" href="#streamingresponse-and-fileresponse-migrations" title="Permanent link">&para;</a></h4>
<p>Migrations for the bodies of <code>fastapi.responses.StreamingResponse</code> and <code>fastapi.responses.FileResponse</code> are not directly supported yet (<a href="https://github.com/zmievsa/cadwyn/issues/125">1</a>, <a href="https://github.com/zmievsa/cadwyn/issues/126">2</a>). However, you can use <code>ResponseInfo._response</code> attribute to get access to the original <code>StreamingResponse</code> or <code>FileResponse</code> and modify it in any way you wish within your migrations.</p>
<h2 id="pydantic-rootmodel-migration-warning">Pydantic RootModel migration warning<a class="headerlink" href="#pydantic-rootmodel-migration-warning" title="Permanent link">&para;</a></h2>
<p>Pydantic has an interesting implementation detail: <code>pydantic.RootModel</code> instances are memoized. So the following code is going to output <code>True</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">RootModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">users</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="n">BulkCreateUsersRequestBody</span> <span class="o">=</span> <span class="n">RootModel</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span>
<span class="n">BulkCreateUsersResponseBody</span> <span class="o">=</span> <span class="n">RootModel</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">BulkCreateUsersRequestBody</span> <span class="ow">is</span> <span class="n">BulkCreateUsersResponseBody</span><span class="p">)</span>  <span class="c1"># True</span>
</code></pre></div>
<p>So if you make a migration that should only affect one of these schemas -- it will automatically affect both. A recommended alternative is to either use subclassing:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">RootModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">users</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="n">UserList</span> <span class="o">=</span> <span class="n">RootModel</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BulkCreateUsersRequestBody</span><span class="p">(</span><span class="n">UserList</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BulkCreateUsersResponseBody</span><span class="p">(</span><span class="n">UserList</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="nb">print</span><span class="p">(</span><span class="n">BulkCreateUsersRequestBody</span> <span class="ow">is</span> <span class="n">BulkCreateUsersResponseBody</span><span class="p">)</span>  <span class="c1"># False</span>
</code></pre></div>
<p>or to specify migrations using <a href="#path-based-migration-specification">endpoint path</a> instead of a schema.</p>
<h2 id="dependency-re-execution-warning">Dependency re-execution warning<a class="headerlink" href="#dependency-re-execution-warning" title="Permanent link">&para;</a></h2>
<p>Notice that whenever a request reaches Cadwyn, it is first validated against the request's version of the schema, then we migrate it to the latest version, and then validate again to prevent migrations from creating invalid requests.</p>
<p>This means that if you have a dependency that is executed during the request validation, <strong>it will be executed twice</strong>. For example, if you have a dependency that checks whether a user exists in the database, it will be executed twice. This is not an issue if the dependency is idempotent, but it becomes one if it is not.</p>
<p>To solve this issue, you can use the <code>cadwyn.current_dependency_solver</code> dependency which tells you whether your dependency is getting called before or after the request is migrated. If you want to run it once we migrated the request to the latest version, you should only run it when <code>current_dependency_solver</code> is <code>"cadwyn"</code>. If you want your dependency to run at the very beginning of handling the request, you should only run it when <code>current_dependency_solver</code> is <code>"fastapi"</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_dependency_solver</span>


<span class="k">def</span><span class="w"> </span><span class="nf">my_dependency</span><span class="p">(</span>
    <span class="n">dependency_solver</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;fastapi&quot;</span><span class="p">,</span> <span class="s2">&quot;cadwyn&quot;</span><span class="p">],</span> <span class="n">Depends</span><span class="p">(</span><span class="n">current_dependency_solver</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">dependency_solver</span> <span class="o">==</span> <span class="s2">&quot;fastapi&quot;</span><span class="p">:</span>  <span class="c1"># Before migration</span>
        <span class="o">...</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># After migration</span>
        <span class="o">...</span>
</code></pre></div>
<p>but the majority of your dependencies will not need this as most dependencies should not have side effects or network calls within them.</p>
<h2 id="version-changes-with-side-effects">Version changes with side effects<a class="headerlink" href="#version-changes-with-side-effects" title="Permanent link">&para;</a></h2>
<p>Sometimes you will use API versioning to handle a breaking change in your <strong>business logic</strong>, not in the schemas themselves. In such cases, it is tempting to add a version check and just follow the new business logic such as:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This is wrong. Please, do not do this.</span>
<span class="k">if</span> <span class="n">api_version_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="c1"># do new logic here</span>
    <span class="o">...</span>
</code></pre></div>
<p>Instead, Cadwyn provides a special <code>VersionChangeWithSideEffects</code> class for handling such cases. It makes finding dangerous versions that have side effects much easier and provides a nice abstraction for checking whether we are on a version where these side effects have been applied.</p>
<p>As an example, let's use the tutorial section's case with the user and their address. Let's say we use an external service to check whether user's address is listed in it and return 400 response if it is not. Let's also say that we only added this check in the newest version.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cadwyn</span><span class="w"> </span><span class="kn">import</span> <span class="n">VersionChangeWithSideEffects</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserAddressIsCheckedInExternalService</span><span class="p">(</span><span class="n">VersionChangeWithSideEffects</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;User&#39;s address is now checked for existence in an external service. &quot;</span>
        <span class="s2">&quot;If it doesn&#39;t exist there, a 400 code is returned.&quot;</span>
    <span class="p">)</span>
</code></pre></div>
<p>Then we will have the following check in our business logic:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.versions</span><span class="w"> </span><span class="kn">import</span> <span class="n">versions</span><span class="p">,</span> <span class="n">UserAddressIsCheckedInExternalService</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">UserAddressIsCheckedInExternalService</span><span class="o">.</span><span class="n">is_applied</span><span class="p">:</span>
        <span class="n">check_user_address_exists_in_an_external_service</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>
<p>So this change can be contained in any version -- your business logic doesn't know which version it has and shouldn't.</p>
<h3 id="warning-against-side-effects">Warning against side effects<a class="headerlink" href="#warning-against-side-effects" title="Permanent link">&para;</a></h3>
<p>Side effects are a very powerful tool but they must be used with great caution. Are you sure you MUST change your business logic? Are you sure whatever you are trying to do cannot just be done by a migration? 90% of time, you will <strong>not</strong> need them. Please, think twice before using them. API Versioning is about having the same underlying app and data while just changing the schemas and api endpoints to interact with it. By introducing side effects, you leak versioning into your business logic and possibly even your data which makes your code significantly harder to maintain in the long term. If each side effect adds a single <code>if</code> to your logic, then after 100 versions with side effects, you will have 100 more <code>if</code>s. If used correctly, Cadwyn helps you maintain decades’ worth of API versions with minimal maintenance effort, and side effects make it significantly harder to do. Changes in the underlying source, structure, or logic of your data should not affect your API or public-facing business logic.</p>
<p>However, the <a href="../../how_to/change_business_logic/">following use cases</a> often necessitate side effects.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../schema_generation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Schema generation">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Schema generation
              </div>
            </div>
          </a>
        
        
          
          <a href="../endpoint_migrations/" class="md-footer__link md-footer__link--next" aria-label="Next: Endpoint migrations">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Endpoint migrations
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "content.footnote.tooltips", "content.code.select"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>